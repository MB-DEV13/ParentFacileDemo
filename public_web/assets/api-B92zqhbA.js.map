{"version":3,"file":"api-B92zqhbA.js","sources":["../../src/services/api.js"],"sourcesContent":["/**\r\n * API utils — ParentFacile\r\n * -------------------------------------------------\r\n * - API_BASE : provient de VITE_API_URL ou reste vide pour profiter du proxy Vite en dev.\r\n * - request() : helper fetch avec timeout + erreurs JSON lisibles.\r\n * - Fonctions exportées : identiques à ta signature + options utiles.\r\n */\r\n\r\nconst API_BASE = (import.meta.env.VITE_API_URL || \"\").replace(/\\/$/, \"\");\r\nconst DEFAULT_TIMEOUT = 12000; // 12s\r\n\r\n/**\r\n * Helper fetch avec timeout, gestion JSON et erreurs explicites.\r\n * @param {string} url\r\n * @param {RequestInit & { timeout?: number }} [options]\r\n */\r\nasync function request(url, options = {}) {\r\n  const { timeout = DEFAULT_TIMEOUT, ...rest } = options;\r\n  const controller = new AbortController();\r\n  const id = setTimeout(() => controller.abort(), timeout);\r\n\r\n  try {\r\n    const res = await fetch(url, {\r\n      credentials: \"include\",\r\n      headers: { Accept: \"application/json\", ...(rest.headers || {}) },\r\n      signal: controller.signal,\r\n      ...rest,\r\n    });\r\n\r\n    // 204 No Content\r\n    if (res.status === 204) return null;\r\n\r\n    const isJson = res.headers.get(\"content-type\")?.includes(\"application/json\");\r\n    const payload = isJson ? await res.json().catch(() => ({})) : await res.text();\r\n\r\n    if (!res.ok) {\r\n      const message =\r\n        (isJson && (payload?.error || payload?.message)) ||\r\n        `HTTP ${res.status} – ${res.statusText}`;\r\n      const err = new Error(message);\r\n      err.status = res.status;\r\n      err.payload = payload;\r\n      throw err;\r\n    }\r\n\r\n    return payload;\r\n  } finally {\r\n    clearTimeout(id);\r\n  }\r\n}\r\n\r\n/** Construit une URL absolue à partir de API_BASE + path */\r\nfunction buildUrl(path) {\r\n  if (!path) return API_BASE || \"\";\r\n  if (/^https?:\\/\\//i.test(path)) return path; \r\n  if (API_BASE && path.startsWith(\"/\")) return `${API_BASE}${path}`;\r\n  return path; \r\n}\r\n\r\n/**\r\n * Récupère la liste des documents.\r\n * @param {Object} [params]\r\n * @param {string} [params.q] \r\n * @param {string} [params.tag]  \r\n * @returns {Promise<{documents: any[]}>}\r\n */\r\nexport async function fetchDocuments(params = {}) {\r\n  const usp = new URLSearchParams();\r\n  if (params.q) usp.set(\"q\", params.q);\r\n  if (params.tag) usp.set(\"tag\", params.tag);\r\n\r\n  const qs = usp.toString();\r\n  const url = buildUrl(`/api/docs${qs ? `?${qs}` : \"\"}`);\r\n  return request(url);\r\n}\r\n\r\n/**\r\n * Déclenche le téléchargement d’un document par redirection.\r\n * @param {string|number} id\r\n */\r\nexport function downloadDocument(id) {\r\n  const url = buildUrl(`/api/docs/${id}/download`);\r\n  // Utilise assign() pour éviter d’ouvrir un nouvel onglet\r\n  window.location.assign(url);\r\n}\r\n\r\n/**\r\n * Télécharge tous les documents dans un ZIP.\r\n */\r\nexport function downloadAllZip() {\r\n  const url = buildUrl(`/api/docs/zip`);\r\n  window.location.assign(url);\r\n}\r\n\r\n/**\r\n * Ouvre un aperçu de document.\r\n * @param {string} publicUrlOrId\r\n * @param {string|number} [fallbackId]\r\n */\r\nexport function previewDocument(publicUrlOrId, fallbackId) {\r\n  let url = \"\";\r\n\r\n  if (publicUrlOrId) {\r\n    // URL absolue (http/https)\r\n    if (/^https?:\\/\\//i.test(publicUrlOrId)) {\r\n      url = publicUrlOrId;\r\n    }\r\n    // Fichiers servis par le backend (/pdfs/...) — proxy en dev, API_BASE en prod\r\n    else if (publicUrlOrId.startsWith(\"/\")) {\r\n      url = buildUrl(publicUrlOrId);\r\n    }\r\n    // sinon, on considérera que c'est un id\r\n    else {\r\n      url = buildUrl(`/api/docs/${publicUrlOrId}/preview`);\r\n    }\r\n  } else if (fallbackId) {\r\n    url = buildUrl(`/api/docs/${fallbackId}/preview`);\r\n  }\r\n\r\n  if (!url) {\r\n    alert(\"Ce document n’a pas d’URL valide\");\r\n    return;\r\n  }\r\n\r\n  // Essaye d’ouvrir dans un nouvel onglet, sinon fallback\r\n  const opened = window.open(url, \"_blank\", \"noopener,noreferrer\");\r\n  if (!opened) window.location.assign(url);\r\n}\r\n\r\n"],"names":["API_BASE","DEFAULT_TIMEOUT","request","url","options","timeout","rest","controller","id","res","isJson","payload","message","err","buildUrl","path","fetchDocuments","params","usp","qs","downloadDocument","downloadAllZip"],"mappings":"AAQA,MAAMA,EAA4C,GAAI,QAAQ,MAAO,EAAE,EACjEC,EAAkB,KAOxB,eAAeC,EAAQC,EAAKC,EAAU,GAAI,CACxC,KAAM,CAAE,QAAAC,EAAUJ,EAAiB,GAAGK,GAASF,EACzCG,EAAa,IAAI,gBACjBC,EAAK,WAAW,IAAMD,EAAW,MAAA,EAASF,CAAO,EAEvD,GAAI,CACF,MAAMI,EAAM,MAAM,MAAMN,EAAK,CAC3B,YAAa,UACb,QAAS,CAAE,OAAQ,mBAAoB,GAAIG,EAAK,SAAW,EAAC,EAC5D,OAAQC,EAAW,OACnB,GAAGD,CAAA,CACJ,EAGD,GAAIG,EAAI,SAAW,IAAK,OAAO,KAE/B,MAAMC,EAASD,EAAI,QAAQ,IAAI,cAAc,GAAG,SAAS,kBAAkB,EACrEE,EAAUD,EAAS,MAAMD,EAAI,KAAA,EAAO,MAAM,KAAO,GAAG,EAAI,MAAMA,EAAI,KAAA,EAExE,GAAI,CAACA,EAAI,GAAI,CACX,MAAMG,EACHF,IAAWC,GAAS,OAASA,GAAS,UACvC,QAAQF,EAAI,MAAM,MAAMA,EAAI,UAAU,GAClCI,EAAM,IAAI,MAAMD,CAAO,EAC7B,MAAAC,EAAI,OAASJ,EAAI,OACjBI,EAAI,QAAUF,EACRE,CACR,CAEA,OAAOF,CACT,QAAA,CACE,aAAaH,CAAE,CACjB,CACF,CAGA,SAASM,EAASC,EAAM,CACtB,OAAKA,EACD,gBAAgB,KAAKA,CAAI,EAAUA,EACnCf,GAAYe,EAAK,WAAW,GAAG,EAAU,GAAGf,CAAQ,GAAGe,CAAI,GACxDA,EAHWf,GAAY,EAIhC,CASA,eAAsBgB,EAAeC,EAAS,GAAI,CAChD,MAAMC,EAAM,IAAI,gBACZD,EAAO,GAAGC,EAAI,IAAI,IAAKD,EAAO,CAAC,EAC/BA,EAAO,KAAKC,EAAI,IAAI,MAAOD,EAAO,GAAG,EAEzC,MAAME,EAAKD,EAAI,SAAA,EACTf,EAAMW,EAAS,YAAYK,EAAK,IAAIA,CAAE,GAAK,EAAE,EAAE,EACrD,OAAOjB,EAAQC,CAAG,CACpB,CAMO,SAASiB,EAAiBZ,EAAI,CACnC,MAAML,EAAMW,EAAS,aAAaN,CAAE,WAAW,EAE/C,OAAO,SAAS,OAAOL,CAAG,CAC5B,CAKO,SAASkB,GAAiB,CAC/B,MAAMlB,EAAMW,EAAS,eAAe,EACpC,OAAO,SAAS,OAAOX,CAAG,CAC5B"}